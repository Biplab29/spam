

<%- include('partials/header') %>

<main class="dashboard-main">
  <div class="container">
    <h2 class="mb-4 text-center">Hello, <%= user.name %> </h2>
    <div class="row g-4">

      <!-- Contacts -->
      <div class="col-lg-6">
        <div class="card shadow-lg rounded-3">
          <div class="card-body">
            <h5 class="card-title">Your Contacts</h5>

            <% if (typeof error !== 'undefined' && error) { %>
              <div class="alert alert-danger"><%= error %></div>
            <% } %>
            <% if (typeof added !== 'undefined' && added) { %>
              <div class="alert alert-success"><%= added %></div>
            <% } %>
            <% if (typeof deleted !== 'undefined' && deleted) { %>
              <div class="alert alert-warning"><%= deleted %></div>
            <% } %>

            <!-- Add Contact Form -->
            <form class="row gy-2 gx-2 align-items-end mb-3" method="POST" action="/contacts">
              <div class="col-md-5">
                <label class="form-label">Name</label>
                <input class="form-control" name="name" required>
              </div>

              <div class="col-md-5">
                <label class="form-label">Phone</label>
                <input class="form-control" name="phone" required>
              </div>
              
              <div class="col-md-2">
                <button class="btn btn-primary w-100">Add</button>
              </div>
            </form>

            <!-- Contact List -->
            <div class="table-responsive">
              <table class="table table-striped table-dark">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Phone</th>
                    <!-- <th>Action</th> -->
                  </tr>
                </thead>
                <tbody>
                  <% (contacts || []).forEach(c => { %>
                    <tr>
                      <td><%= c.name %></td>
                      <td><%= c.phone %></td>
                      <!-- <td>
                        <form method="POST" action="/contacts/<%= c._id %>?_method=DELETE" style="display:inline;">
                          <button class="btn btn-danger btn-sm">Delete</button>
                        </form>
                      </td> -->
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Search & Spam -->
      <div class="col-lg-6">
        <div class="card shadow-lg rounded-3">
          <div class="card-body">
            <h5 class="card-title">Search</h5>
            <form id="searchForm" class="row gy-2 gx-2 align-items-end mb-3">
              <div class="col-md-6">
                <input class="form-control" id="q" placeholder="name or phone">
              </div>
              <div class="col-md-4">
                <label class="form-label">Type</label>
                <select class="form-select" id="type">
                  <option value="name">By Name</option>
                  <option value="phone">By Phone</option>
                </select>
              </div>
              <div class="col-md-2">
                <button class="btn btn-outline-secondary w-100">Go</button>
              </div>
            </form>
            <div id="results"></div>

            <hr/>
            <form id="spamForm" class="row gy-2 gx-2 align-items-end">
              <div class="col-md-8">
                <label class="form-label">Mark Number as Spam</label>
                <input class="form-control" id="spamPhone" placeholder="e.g. 9998887777" required>
              </div>
              <div class="col-md-4">
                <button class="btn btn-danger w-100">Report</button>
              </div>
            </form>
            <div id="spamMsg" class="mt-2"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</main>


<script>
document.getElementById("searchForm").addEventListener("submit", async (e) => {
  
  e.preventDefault();
  const q = document.getElementById("q").value.trim();
  const type = document.getElementById("type").value;
  const res = await fetch(`/search?q=${encodeURIComponent(q)}&type=${encodeURIComponent(type)}`);
  const data = await res.json();
  const div = document.getElementById("results");
  if (!data.length) return div.innerHTML = '<div class="alert alert-info">No results</div>';
  let html = '<div class="table-responsive"><table class="table table-hover table-dark"><thead><tr><th>Name</th><th>Phone</th><th>Spam %</th></tr></thead><tbody>';
  html += data.map(r => `<tr><td>${r.name}</td><td>${r.phone}</td><td>${r.spam}</td></tr>`).join("");
  html += '</tbody></table></div>';
  div.innerHTML = html;
});

document.getElementById("spamForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const phone = document.getElementById("spamPhone").value.trim();
  const res = await fetch("/spam", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ phone })
  });

  const msgDiv = document.getElementById("spamMsg");
  if (res.ok) {
    msgDiv.innerHTML = '<div class="alert alert-success">Marked as spam</div>';
  } else {
    const j = await res.json().catch(()=>({message:'Error'}));
    msgDiv.innerHTML = `<div class="alert alert-danger">${j.message || 'Error'}</div>`;
  }
});
</script>

<%- include('partials/footer') %>

